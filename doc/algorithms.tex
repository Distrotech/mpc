\documentclass {article}

\usepackage[a4paper]{geometry}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{amsmath,amssymb}

\newcommand {\mpc}{\texttt {mpc}}
\newcommand {\mpfr}{\texttt {mpfr}}
\newcommand {\ulp}[1]{#1~ulp}
\newcommand {\atantwo}{\operatorname {atan2}}
\DeclareMathOperator{\error}{error}
\newcommand {\Ulp}{{\rm ulp}}
\newcommand {\Exp}{{\rm \textsc exp}}

\title {MPC: Algorithms and Error Analysis}
\author {Andreas Enge \and Philippe Th\'eveny}
\date {April 11, 2008}

\begin {document}
\maketitle
\tableofcontents


\section {Error analysis}

This section is devoted to the analysis of error propagation: Given a function
whose input arguments already have a certain error, what is the error bound on
the function output? The output error usually consists of two components: The
error propagated from the input, which may be arbitrarily amplified; and an
additional small error accounting for the rounding of the output. The results
are needed for algorithms that combine several arithmetic operations.

We will assume that the real and imaginary parts of the operands have the same
precision.

Let $z_1 = \circ(\widetilde{z_1})$ and $z_2 = \circ(\widetilde{z_2})$, with
$\widetilde{z_n} = \widetilde{x_n} + i \widetilde{y_n}$ and $z_n = x_n + i
y_n$, the two operands in the following operations rounded at the working
precision, the error on real and imaginary parts are $\error(x_n) \leq k_{R,n}
\Ulp(x_n)$, and $\error(y_n) \leq k_{I,n} \Ulp(y_n)$.

\subsection {Generic error for addition/substraction}

\[
z=\circ(\widetilde{z_1}+\widetilde{z_2})
\]
\begin{eqnarray}\nonumber
\error(x)&=&|x-\Re(\widetilde{z_1}-\widetilde{z_2})|\\\nonumber
&\leq&|x-\Re(z_1-z_2)|+|\Re(z_1+z_2)-\Re(\widetilde{z_1}+\widetilde{z_2})|\\\nonumber
&\leq&c_R \Ulp(x) + |x_1 - \widetilde{x_1}| + |x_2 -
\widetilde{x_2}|\\\nonumber &\leq&c_R \Ulp(x) + k_{R,1} \Ulp(x_1) + k_{R,2}
\Ulp(x_2)\\\nonumber &\leq&\left(c_R + 2^{d_{R,1}} k_{R,1} + 2^{d_{R,2}}
k_{R,2} \right) \Ulp(x) \nonumber
\end{eqnarray}
where $d_{R,n}=\Exp(x_n)-\Exp(x)$ and $c_R=\frac{1}{2}$ if the real part is
rounded to nearest, else $c_R=1$. If $x_1x_2 \geq 0$, then we have a simpler
expression
\[
\error(x) \leq (c_R+k_{R,1}+k_{R,2}) \Ulp(x)
\]
In the same way, we can show that the generic error of the imaginary part is
\[
\error (y) \leq \left(c_I + 2^{d_{I,1}} k_{I,1} + 2^{d_{I,2}} k_{I,2} \right)
\Ulp(y)
\]
where $d_{I,n}=\Exp(y_n)-\Exp(y)$ and $c_I=\frac{1}{2}$ if the imaginary part
is rounded to nearest, else $c_I=1$. If $y_1y_2 \geq 0$, then we have the
simpler expression
\[
\error(y) \leq (c_I+k_{I,1}+k_{I,2}) \Ulp(y)
\]


\subsection {generic error for multiplication}

\[
z=\circ(\widetilde{z_1}\times\widetilde{z_2})
\]
\begin{eqnarray}\nonumber
\error(x)&=&|x-\Re(\widetilde{z_1}\times \widetilde{z_2})|\\\nonumber &\leq&
|x-\Re(z_1\times z_2)|+|\Re(z_1\times
z_2)-\Re(\widetilde{z_1}\times\widetilde{z_2})| \\\nonumber &\leq&
c_R\Ulp(x)+|x_1x_2-y_1y_2-(\widetilde{x_1}\widetilde{x_2}-\widetilde{y_1}\widetilde{y_2})|
\\\nonumber &\leq&
c_R\Ulp(x)+|x_1x_2-\widetilde{x_1}\widetilde{x_2}|+|y_1y_2-\widetilde{y_1}\widetilde{y_2}|
\\\nonumber
\end{eqnarray}
If [$x_1x_2 \geq 0$ and $y_1y_2 \geq 0$] or [$x_1x_2 \leq 0$ and $y_1y_2 \leq
  0$] then $\Ulp(x_1x_2) \leq \Ulp(x)$ and $\Ulp(y_1y_2) \leq \Ulp(x)$, so we
have
\[
\error(x) \leq \left(c_R + (1+c_{R,1}^+)k_{R,2} + (1+c_{R,2}^+)k_{R,1} +
(1+c_{I,1}^+)k_{I,2} + (1+c_{I,2}^+)k_{I,1} \right) \Ulp(x)
\]
where $c_{\cdot,n}^+ = 1+k_{\cdot,n}2^{1-p}$.
If $x_1x_2$ and $y_1y_2$ don't have the same sign, then the inequality is
\[
\error(x) \leq \left( c_R + \left( (1+c_{R,1}^+)k_{R,2} + (1+c_{R,2}^+)k_{R,1}
\right)2^d + \left( (1+c_{I,1}^+)k_{I,2} + (1+c_{I,2}^+)k_{I,1} \right)2^{d'}
\right) \Ulp(x)
\]
where $d = \Exp(x_1x_2)-\Exp(x) \leq \Exp(x_1)+\Exp(x_2)-\Exp(x)$ and $d' =
\Exp(y_1y_2)-\Exp(x) \leq \Exp(y_1)+\Exp(y_2)-\Exp(x)$

Error of the imaginary part can be bounded the same way. If $x_1y_2$ and
$x_2y_1$ have the same sign, then
\[
\error(y) \leq \left(c_I + (1+c_{R,1}^+)k_{I,2} + (1+c_{I,2}^+)k_{R,1} +
(1+c_{I,1}^+)k_{R,2} + (1+c_{R,2}^+)k_{I,1} \right) \Ulp(y)
\]
If $x_1y_2$ and $y_1x_2$ don't have the same sign, then
\[
\error(y) \leq \left( c_I + \left( (1+c_{R,1}^+)k_{I,2} + (1+c_{I,2}^+)k_{R,1}
\right)2^{\delta} + \left( (1+c_{I,1}^+)k_{R,2} + (1+c_{R,2}^+)k_{I,1} \right)
2^{\delta'}\right) \Ulp(y)
\]
where $\delta = \Exp(x_1y_2)-\Exp(y) \leq \Exp(x_1)+\Exp(y_2)-\Exp(y)$ and
$\delta' = \Exp(y_1x_2)-\Exp(y) \leq \Exp(y_1)+\Exp(x_2)-\Exp(y)$


\section {Algorithms}

This section describes in detail the algorithms used in \mpc, together with the error analysis that allows to prove that the results are correct in the {\mpc} semantics: The input numbers are assumed to be exact, and the output corresponds to the exact result rounded in the desired direction.


\subsection {\texttt {mpc\_sqrt}}

Let $z = x + i y$.

Let $w = \sqrt { \frac {|x| + \sqrt {x^2 + y^2}}{2}}$ and
$t = \frac {y}{2w}$. Then $(w + it)^2 = |x| + iy$, and with the branch cut on the negative real axis we obtain
\[
\sqrt z = \left\{
\begin {array}{cl}
w + i t & \text {if } x > 0 \\
t + i w & \text {if } x < 0, y > 0 \\
-t - i w & \text {if } x < 0, y < 0
\end {array}
\right.
\]

$w$ is rounded down. $\sqrt {x^2 + y^2}$ is computed with an error of \ulp{1}; $|x|$ is added with an error of \ulp{1}, since both terms are positive. The generic error of the real square root in the special case that the argument was rounded down is \ulp{1}, so that the total error in computing $w$ is \ulp{3}.

$t$ is rounded up. The generic error of real division, applied to an error of \ulp{3} for $w$ and \ulp{0} for $y$ implies an error of \ulp{7}.


\subsection {\texttt {mpc\_log}}

Let $z = x + i y$. Then $\log (z) = \frac {1}{2} \log (x^2 + y^2) + i \atantwo (y, x)$. The imaginary part is computed by a call to the corresponding {\mpfr} function.

Let $w = \log (x^2 + y^2)$, rounded down. The error of the complex norm is \ulp{1}. The generic error of the real logarithm is then given by \ulp{$2^{2 - e_w} + 1$}, where $e_w$ is the exponent of $w$. For $e_w \geq 2$, this is bounded by \ulp{2} or 2~digits; otherwise, it is bounded by \ulp{$2^{3 - e_w}$} or $3 - e_w$ digits.

\end {document}
